\newcommand{\Exp}{\mathrm{E}}
\newcommand\given[1][]{\:#1\vert\:}
\newcommand{\Cov}{\mathrm{Cov}}
\newcommand{\Var}{\mathrm{Var}}
\newcommand{\rank}{\mathrm{rank}}
\newcommand{\bm}[1]{\boldsymbol{\mathbf{#1}}}

# Exercise II

### Required packages {.unnumbered}

```{r, message = FALSE, warning = FALSE, results = 'hide'}
pkgs <- c("sf", "mapview", "spdep", "spatialreg", "tmap", "viridisLite") # note: load spdep first, then spatialreg
lapply(pkgs, require, character.only = TRUE)

```

### Session info {.unnumbered}

```{r}
sessionInfo()

```

### Reload data from pervious session {.unnumbered}

```{r}
load("_data/msoa2_spatial.RData")
```


## Environmental inequality

How would you investigate the following descriptive research question: Are ethnic (and immigrant) minorities in London exposed to higher levels of pollution? Also consider the spatial structure. What's your dependent and whats your independent variable?

### 1) Define a neigbours weights object of your choice {.unnumbered}

Assume a typical neighbourhood would be 2.5km in diameter

```{r}
coords <- st_centroid(msoa.spdf)

# Neighbours within 3km distance
dist_15.nb <- dnearneigh(coords, d1 = 0, d2 = 2500)

summary(dist_15.nb)

# There are some mpty one. Lets impute with the nearest neighbour
k2.nb <- knearneigh(coords, k = 1)

# Replace zero
nolink_ids <- which(card(dist_15.nb) == 0)
dist_15.nb[card(dist_15.nb) == 0] <- k2.nb$nn[nolink_ids, ]

summary(dist_15.nb)

# listw object with row-normalization
dist_15.lw <- nb2listw(dist_15.nb, style = "W")

```


### 2) Estimate the extent of spatial auto-correlation {.unnumbered}

```{r}
moran.test(msoa.spdf$no2, listw = dist_15.lw)
```


### 3) Estimate a spatial SAR regression model {.unnumbered}

a) Estimate a spatial autoregressive SAR model


b) Have a look into the true multiplier matrix $({\bm I_N}-\rho {\bm W})^{-1}\beta_k$


c) Create an $N \times N$ effects matrix. What is the effect of unit 6 on unit 10?


d) Estimate a spatial autoregressive SLX model


e) Calculate and interpret the summary impact measures for SAR and SLX.



### 4) Is SAR the right model choice or would you rather estimate a different model? {.unnumbered}

f) How do results change once you specify a spatial Durbin model?

g) Please calculate and interpret the impacts for a spatial Durbin model.




## Life Expecatancy in Germany

Below, we read and transform some characteristics of the [INKAR data](https://www.inkar.de/) on German counties.


```{r}
load("_data/inkar2.Rdata")
```


Variables are

| Variable | Description |
| ------------					   | ------------ |
| "Kennziffer"                      | ID                                         |
| "Raumeinheit"                     | Name                                       |
| "Aggregat"                        | Level                                      |
| "year"                            | Year                                       |
| "poluation_density"               | Population Density       |
| "median_income"                   | Median Household income (only for 2020)                   |
| "gdp_in1000EUR"                   | Gross Domestic Product in 1000 euros                            |
| "unemployment_rate"               | Unemployment rate                            |
| "share_longterm_unemployed"       | Share of longterm unemployed (among unemployed)                               |
| "share_working_indutry"           | Share of employees in undistrial sector                    |
| "share_foreigners"                | Share of foreign nationals                              |
| "share_college"                   | Share of school-finishers with college degree                              |
| "recreational_space"              | Recreational space per inhabitant                           |
| "car_density"                     | Density of cars                                 |
| "life_expectancy"                 | Life expectancy       |


And we get the respective county shapes:

```{r}
kreise.spdf <- st_read(dsn = "_data/vg5000_ebenen_1231",
                       layer = "VG5000_KRS")
```



<!-- ### Please map the life expectancy across Germany -->

<!-- ### Test the effect of regional characteristics on life expectancy -->

### 1) Merge data with the shape file (as with conventional data)



### 2) Create a map of life-expectancy



### 3) Chose some variables that could predict life expectancy. See for instance the [following paper](https://doi.org/10.1073/pnas.2003719117).


### 4) Generate a neighbours object (e.g. the 10 nearest neighbours).



### 5) Estimate a cross-sectional spatial model for the year 2020 and calculate the impacts.




### 6) Calculate the spatial lagged variables for your covariates (e.g. use create_WX(), which needs a non-spatial df as input) .




### 6) Can you run a spatial machine learning model? (for instance, using `randomForest`)?


You could even go further and use higher order neighbours (e.g. `nblag(queens.nb, maxlag = 3)`) to check the importance of direct neighbours and the neighbours neighbours and so on ...


